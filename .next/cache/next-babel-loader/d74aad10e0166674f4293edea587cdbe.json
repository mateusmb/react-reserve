{"ast":null,"code":"import Stripe from 'stripe';\nimport uuidv4 from 'uuid/v4';\nimport jwt from 'jsonwebtoken';\nimport Cart from '../../models/Cart';\nimport Order from '../../models/Order';\nimport calculateCartTotal from '../../utils/calculateCartTotal';\nconst stripe = Stripe(process.env.STRIPE_SECRET_KEY);\nexport default (async (req, res) => {\n  const {\n    paymentData\n  } = req.body;\n\n  try {\n    const {\n      userId\n    } = jwt.verify(req.headers.authorization, process.env.JWT_SECRET);\n    const cart = Cart.findOne({\n      user: userId\n    }).populate({\n      path: \"products.product\",\n      model: \"Product\"\n    });\n    const {\n      cartTotal,\n      stripeTotal\n    } = calculateCartTotal(cart.products);\n    const prevCustomer = await stripe.customers.list({\n      email: paymentData.email,\n      limit: 1\n    });\n    const isExistingCustomer = prevCustomer.data.length > 0;\n    let newCustomer;\n\n    if (!isExistingCustomer) {\n      newCustomer = await stripe.customers.create({\n        email: paymentData.email,\n        source: paymentData.id\n      });\n    }\n\n    const customer = isExistingCustomer && prevCustomer.data[0].id || newCustomer.id;\n    const charge = await stripe.charges.create({\n      currency: \"usd\",\n      amount: stripeTotal,\n      receipt_email: paymentData.email,\n      customer,\n      description: `Checkout | ${paymentData.email} | ${paymentData.id}`\n    }, {\n      idempotency_key: uuidv4()\n    });\n    await Order({\n      user: userId,\n      email: paymentData.email,\n      total: cartTotal,\n      products: cart.products\n    }).save();\n    await Cart.findOneAndUpdate({\n      _id: cart._id\n    }, {\n      $set: {\n        products: []\n      }\n    });\n    res.status(200).send(\"Checkout success\");\n  } catch (error) {\n    console.error(error);\n    res.status(500).send(\"Error processing charge\");\n  }\n});","map":{"version":3,"sources":["/home/magikoopa/Dev/react-reserve/pages/api/checkout.js"],"names":["Stripe","uuidv4","jwt","Cart","Order","calculateCartTotal","stripe","process","env","STRIPE_SECRET_KEY","req","res","paymentData","body","userId","verify","headers","authorization","JWT_SECRET","cart","findOne","user","populate","path","model","cartTotal","stripeTotal","products","prevCustomer","customers","list","email","limit","isExistingCustomer","data","length","newCustomer","create","source","id","customer","charge","charges","currency","amount","receipt_email","description","idempotency_key","total","save","findOneAndUpdate","_id","$set","status","send","error","console"],"mappings":"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","sourcesContent":["import Stripe from 'stripe';\nimport uuidv4 from 'uuid/v4';\nimport jwt from 'jsonwebtoken';\nimport Cart from '../../models/Cart'\nimport Order from '../../models/Order'\nimport calculateCartTotal from '../../utils/calculateCartTotal'\n\nconst stripe = Stripe(process.env.STRIPE_SECRET_KEY);\n\nexport default async (req, res) => {\n    const { paymentData } = req.body;\n\n    try {\n        const { userId } = jwt.verify(req.headers.authorization, process.env.JWT_SECRET)\n        const cart = Cart.findOne({ user: userId }).populate({\n            path: \"products.product\",\n            model: \"Product\"\n        })\n        const { cartTotal, stripeTotal } = calculateCartTotal(cart.products);\n        const prevCustomer = await stripe.customers.list({\n            email: paymentData.email,\n            limit: 1\n        })\n        const isExistingCustomer = prevCustomer.data.length > 0;\n        let newCustomer;\n        if (!isExistingCustomer) {\n            newCustomer = await stripe.customers.create({\n                email: paymentData.email,\n                source: paymentData.id\n            })\n        }\n        const customer = (isExistingCustomer  && prevCustomer.data[0].id) || newCustomer.id;\n        const charge = await stripe.charges.create({\n            currency: \"usd\",\n            amount: stripeTotal,\n            receipt_email: paymentData.email,\n            customer,\n            description: `Checkout | ${paymentData.email} | ${paymentData.id}`            \n        }, {\n            idempotency_key: uuidv4()\n        })\n\n        await Order({\n            user: userId,\n            email: paymentData.email,\n            total: cartTotal,\n            products: cart.products\n        }).save()\n\n        await Cart.findOneAndUpdate(\n            { _id: cart._id },\n            { $set: { products: [] } }\n        )\n\n        res.status(200).send(\"Checkout success\")\n\n    } catch (error) {\n        console.error(error);\n        res.status(500).send(\"Error processing charge\");\n    }\n}"]},"metadata":{},"sourceType":"module"}